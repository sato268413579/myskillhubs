# Interactive WebRTC Workspace - Requirements Document

## 1. 全体構成（MySkillHubs）

### 1.1 プロジェクト概要

MySkillHubsは、複数のPoC（Proof of Concept）機能を統合した個人開発アプリケーションです。各PoC機能は独立して動作し、共通の認証基盤とバックエンドAPIを共有します。

### 1.2 システムアーキテクチャ

```
MySkillHubs (個人開発PoC統合アプリ)
├── フロントエンド: React 19.1.1 + TypeScript
├── バックエンド: Flask (Python) + Flask-Login
├── データベース: MySQL (SQLAlchemy)
└── 認証: Flask-Login + セッション管理
```

### 1.3 実装済みPoC機能一覧

| 機能名 | 説明 | 主要技術 | エンドポイント | 状態 |
|--------|------|----------|----------------|------|
| **タスク管理ツール** | シンプルなTodo管理 | React, Flask | `/service/tasks` | 稼働中 |
| **CRM（顧客管理）** | 顧客情報、取引履歴、コンタクトログの管理 | React, Flask, MySQL | `/service/crm` | 稼働中 |
| **AI情報収集** | 2段階AI分析によるトレンド調査 | React, Flask, AI API | `/service/aiSearch` | 稼働中 |
| **2D WebRTCウィンドウマネージャー** | タブキャプチャとウィンドウ管理 | React, WebRTC, Flask | `/service/3d` | 稼働中（拡張予定） |

### 1.4 共通基盤

#### 1.4.1 認証・セッション管理
- **Flask-Login**: ユーザー認証
- **セッション管理**: Cookieベースのセッション
- **CORS設定**: `http://localhost:3000`からのアクセス許可

#### 1.4.2 データベース
- **MySQL**: 顧客データ、タスクデータの永続化
- **SQLAlchemy**: ORM
- **In-Memory Storage**: セッション同期データ（一時的）

#### 1.4.3 API構造
```
/api
├── /crm/*              # CRM機能
├── /trendSearch/*      # AI情報収集
├── /service/3d/*       # 2D WebRTCウィンドウマネージャー
├── /sync-session/*     # セッション同期（共通）
└── /login/*            # 認証（共通）
```

### 1.5 本要件書の対象範囲

本ドキュメントは、**「2D WebRTCウィンドウマネージャー」の機能拡張要件**のみを対象とします。

**対象:**
- 2D WebRTCウィンドウマネージャー（`/service/3d`）
- 関連バックエンドAPI（`/api/service/3d/*`, `/api/sync-session/*`）

**対象外:**
- タスク管理ツール
- CRM機能
- AI情報収集機能
- 共通認証基盤（既存のFlask-Loginを活用）

## 2. 2D WebRTCウィンドウマネージャー - 概要

### 2.1 機能の位置づけ

MySkillHubs内の実験的機能として、WebRTC技術を活用したタブキャプチャとウィンドウ管理を提供します。

**進化の経緯:**
1. **Phase 0（過去）**: 3D空間でのWebアプリナビゲーション（Three.js使用）
2. **Phase 1（現在）**: 2D平面でのウィンドウ管理とリアルタイムタブキャプチャ
3. **Phase 2（本要件書）**: リモート操作機能とセキュリティ強化
4. **Phase 3（将来）**: AI支援、モバイル対応

### 2.2 本要件書の目的

既存の2D WebRTCウィンドウマネージャーを基盤として、以下の機能を段階的に追加します:

1. **リモート操作機能**: キャプチャしたタブへの操作転送・実行
2. **セキュリティ強化**: エンドツーエンド暗号化、OAuth統合
3. **ウィンドウ管理拡張**: グループ化、俯瞰モード
4. **パフォーマンス最適化**: 複数ストリーム対応

## 3. 現在の実装状況

### 3.1 実装済み機能

#### 3.1.1 コア機能
| 機能 | 説明 | 実装状況 |
|------|------|----------|
| **2Dウィンドウマネージャー** | ドラッグ、リサイズ、カメラ操作（パン、ズーム） | ✅ 完了 |
| **WebRTCタブキャプチャ** | getDisplayMedia APIによるリアルタイムストリーミング | ✅ 完了 |
| **Electronキャプチャ** | 基礎構造（モックモード対応） | ✅ 完了 |
| **セッション同期API** | Gmail、GitHub、Notion、Slack対応 | ✅ 完了 |
| **WebAppPreviewCard** | Webアプリプレビューとクイックアクション | ✅ 完了 |

#### 3.1.2 主要コンポーネント
- **WindowManager2D**: 2D平面でのウィンドウ配置・管理
- **ResizableWindow**: ドラッグ移動・リサイズ可能なウィンドウ
- **InteractiveTabCapture**: 操作イベント送信の基礎構造
- **WebAppPreviewCard**: Webアプリプレビューカード

#### 3.1.3 バックエンドAPI
- `POST /api/service/3d/start-electron-capture`: Electronキャプチャ開始
- `POST /api/service/3d/send-interaction`: 操作イベント送信
- `POST /api/sync-session/<app_id>`: セッション同期
- `GET /api/session-status/<app_id>`: セッション状態取得

### 3.2 技術スタック

#### 3.2.1 フロントエンド
- **React**: 19.1.1
- **TypeScript**: 4.9.5
- **WebRTC API**: getDisplayMedia
- **状態管理**: React Hooks (useState, useCallback, useEffect)

#### 3.2.2 バックエンド
- **Flask**: Python Webフレームワーク
- **Flask-Login**: セッション管理
- **セキュリティ**: HMAC-SHA256トークン生成・検証

#### 3.2.3 通信プロトコル
- **HTTP/HTTPS**: REST API
- **WebRTC**: メディアストリーミング（getDisplayMedia）
- **WebSocket**: 将来実装予定（DataChannel用）

### 3.3 未実装・改善が必要な機能

#### 3.3.1 Phase 1（最優先）
- ❌ リモート操作の実際の実行機能（Chrome拡張機能が必要）
- ❌ Chrome拡張機能の開発（Manifest V3）
- 🚧 セキュリティトークンの強化
- 🚧 基本的な監査ログ機能

#### 3.3.2 Phase 2（次の優先）
- ❌ WebRTC DataChannelによる双方向通信
- ❌ エンドツーエンド暗号化（AES-256-GCM）
- ❌ OAuth 2.0統合（実際の認証フロー）
- ❌ ウィンドウグループ化機能
- ❌ 俯瞰モード・グリッド表示

#### 3.3.3 Phase 3（将来実装）
- ❌ 多要素認証（MFA）
- ❌ データマスキング機能
- ❌ AI支援機能（レイアウト最適化、情報抽出）
- ❌ モバイルアプリ（React Native）
- ❌ 企業向け管理ダッシュボード

## 4. 機能要件

本セクションでは、2D WebRTCウィンドウマネージャーの各機能について、段階的な要件を定義します。

### 4.1 リモート操作機能（Phase 1実装）

**User Story:** As a ユーザー, I want キャプチャしたタブに対してクリック・スクロール操作を行いたい, so that 単なる閲覧ではなく基本的な操作ができる

**現状:** InteractiveTabCaptureコンポーネントに操作イベント送信の基礎構造は実装済み。実際の操作転送・実行機能が未実装。

#### Acceptance Criteria

1. WHEN ユーザーがキャプチャされたタブ内でクリックする THEN そのクリック座標がバックエンドAPIに送信される
2. WHEN ユーザーがキャプチャされたタブ内でスクロールする THEN スクロール情報がバックエンドAPIに送信される
3. WHEN バックエンドが操作イベントを受信する THEN Electronプロセスまたはブラウザ拡張機能に転送される
4. WHEN 操作が実行される THEN 実行結果がログに記録される
5. IF 操作転送が有効でない場合 THEN 操作は送信されず、UIに状態が表示される

**技術的制約:**
- Chrome拡張機能またはElectronアプリが必要
- セキュリティポリシーによりクロスオリジン操作に制限あり
- 初期実装では同一ドメイン内の操作のみサポート

### 4.2 セキュリティ・プライバシー保護（段階的実装）

**User Story:** As a 企業ユーザー, I want 業務データが安全に保護された状態で通信を行いたい, so that 基本的なセキュリティ要件を満たせる

**現状:** 
- セッショントークン生成機能は実装済み（HMAC-SHA256）
- 基本的な認証チェックは実装済み
- エンドツーエンド暗号化、MFA、データマスキングは未実装

#### Acceptance Criteria（Phase 1）

1. WHEN ユーザーがログインする THEN セッショントークンが生成され、HTTPSで通信される
2. WHEN キャプチャセッションが開始される THEN セキュアトークンが発行される
3. WHEN 操作イベントが送信される THEN トークン検証が行われる
4. WHEN セッションが開始される THEN 基本的な操作ログが記録される
5. IF トークンが無効な場合 THEN 操作は拒否され、エラーが返される

#### Acceptance Criteria（Phase 2 - 将来実装）

1. WebRTC DataChannelでのエンドツーエンド暗号化（AES-256-GCM）
2. OAuth 2.0 + OpenID Connect統合
3. 多要素認証（MFA）サポート
4. 自動データマスキング機能
5. GDPR/SOC2準拠の監査ログ

### 4.3 複数同時管理・俯瞰ビュー（既存機能の強化）

**User Story:** As a マルチタスクユーザー, I want 複数のWebアプリケーションを同時に表示・管理したい, so that 効率的にタスクを管理できる

**現状:** 
- 2Dウィンドウマネージャーで複数ウィンドウの同時表示は実装済み
- カメラ操作（パン、ズーム）は実装済み
- グループ化、俯瞰モード、アクティビティ検知は未実装

#### Acceptance Criteria（Phase 1）

1. WHEN ユーザーが複数のタブをキャプチャする THEN すべてのタブが個別のウィンドウとして表示される
2. WHEN ユーザーがカメラを操作する THEN スムーズにパン・ズームできる
3. WHEN ウィンドウが多数ある場合 THEN カメラ操作で全体を俯瞰できる
4. WHEN ストリームが停止される THEN 該当ウィンドウが自動的に削除される
5. WHEN アクティブストリーム数が表示される THEN リアルタイムで更新される

#### Acceptance Criteria（Phase 2 - 将来実装）

1. ウィンドウのグループ化機能
2. グリッド表示モード
3. アクティビティ検知とハイライト
4. 自動品質調整
5. パフォーマンスモニタリング

### 4.4 Webアプリ統合（Phase 2実装）

**User Story:** As a ユーザー, I want よく使うWebアプリケーションに素早くアクセスしたい, so that 作業効率を向上できる

**現状:** 
- WebAppPreviewCardコンポーネントは実装済み
- セッション同期APIは実装済み（Gmail、GitHub、Notion、Slack）
- 実際のOAuth連携とタスク管理機能は未実装

#### Acceptance Criteria（Phase 1）

1. WHEN ユーザーがWebアプリウィンドウを追加する THEN プレビューカードが表示される
2. WHEN ユーザーが「ブラウザで開く」をクリックする THEN 新しいタブでWebアプリが開かれる
3. WHEN ユーザーが「セッション同期」をクリックする THEN セッション同期APIが呼ばれる
4. WHEN セッション同期が成功する THEN UIに同期状態が表示される
5. WHEN セッション状態がチェックされる THEN 有効期限が確認される

#### Acceptance Criteria（Phase 2 - 将来実装）

1. 実際のOAuth 2.0フロー統合
2. タスク管理システムとの連携
3. ワークフロー自動化
4. チームコラボレーション機能
5. 進捗レポート生成

### 4.5 AI支援機能（Phase 3 - 将来実装）

**User Story:** As a 知識ワーカー, I want AI支援によってワークスペースが最適化されることを望む, so that より効率的に作業できる

**現状:** 未実装。Phase 3以降で検討。

#### Acceptance Criteria（将来実装）

1. ユーザーの作業パターン学習と最適レイアウト提案
2. 重要情報の自動検出とハイライト
3. 類似タスクの最適解提案
4. 集中度モニタリングと休憩提案
5. 異常アクティビティ検出とセキュリティアラート

**技術的要件:**
- 機械学習モデルの選定と訓練
- ユーザー行動データの収集と分析
- プライバシーに配慮したデータ処理
- リアルタイム推論インフラ

### 4.6 パフォーマンス最適化（段階的改善）

**User Story:** As a ユーザー, I want 複数のストリームを同時実行してもスムーズに動作することを望む, so that 快適に作業できる

**現状:** 
- 基本的なストリーム管理は実装済み
- パフォーマンス最適化、品質調整は未実装

#### Acceptance Criteria（Phase 1）

1. WHEN 3-5個のストリームが同時実行される THEN 基本的な動作が維持される
2. WHEN ストリームが停止される THEN リソースが適切に解放される
3. WHEN ウィンドウが多数ある場合 THEN UIの応答性が維持される
4. WHEN メモリリークが発生しない THEN 長時間使用でも安定動作する
5. WHEN ブラウザのパフォーマンスツールで確認する THEN 明らかなボトルネックがない

#### Acceptance Criteria（Phase 2 - 将来実装）

1. 10個以上のストリームで30fps維持
2. 自動品質調整機能
3. 優先度ベースのリソース管理
4. リアルタイムパフォーマンスモニタリング
5. 自動リカバリ機能

### 4.7 企業向け管理機能（Phase 3 - 将来実装）

**User Story:** As a IT管理者, I want ワークスペースの使用状況を管理したい, so that セキュリティを確保できる

**現状:** 未実装。Phase 3以降で検討。

#### Acceptance Criteria（将来実装）

1. 管理者ダッシュボード
2. ユーザー使用状況の可視化
3. ポリシー管理と自動適用
4. 監査ログとレポート機能
5. セキュリティインシデント管理

**技術的要件:**
- 管理者用バックエンドAPI
- ロールベースアクセス制御（RBAC）
- 監査ログストレージ
- レポート生成機能
- アラート通知システム

### 4.8 モバイル・クロスプラットフォーム対応（Phase 3 - 将来実装）

**User Story:** As a モバイルユーザー, I want スマートフォンやタブレットからもワークスペースにアクセスしたい, so that 場所を選ばず作業できる

**現状:** デスクトップブラウザのみ対応。モバイル対応は未実装。

#### Acceptance Criteria（将来実装）

1. タッチ操作対応UI
2. レスポンシブデザイン
3. モバイルブラウザ最適化
4. オフライン機能（Service Worker）
5. 省電力モード

**技術的要件:**
- React Nativeアプリ開発（オプション）
- レスポンシブCSS実装
- タッチイベント処理
- Service Worker実装
- モバイルブラウザテスト

## 5. 非機能要件

### 5.1 セキュリティ要件
- エンドツーエンド暗号化（AES-256）
- OAuth 2.0 + OpenID Connect認証
- RBAC（Role-Based Access Control）
- SOC2 Type II準拠
- GDPR準拠のデータ処理

### 5.2 パフォーマンス要件
- 初期ロード時間: 3秒以内
- 操作レスポンス時間: 100ms以内
- 同時接続数: 1000ユーザー以上
- 可用性: 99.9%以上

### 5.3 互換性要件
- Chrome 90+, Firefox 88+, Safari 14+, Edge 90+
- Windows 10+, macOS 11+, Ubuntu 20.04+
- iOS 14+, Android 10+

## 6. 成功基準

### Phase 1（現在の目標）
1. **基本機能**: タブキャプチャとウィンドウ管理が安定動作
2. **操作性**: リモート操作イベントの送信が実装される
3. **セキュリティ**: 基本的なトークン認証が機能する
4. **パフォーマンス**: 3-5個のストリームで快適に動作
5. **ユーザビリティ**: 直感的なUI/UX

### Phase 2（次の目標）
1. **操作性**: リモート操作の実行が実装され、遅延が500ms以下
2. **セキュリティ**: エンドツーエンド暗号化が実装される
3. **統合**: OAuth連携が実装される
4. **パフォーマンス**: 10個以上のストリームで30fps維持
5. **機能**: グループ化、俯瞰モードが実装される

### Phase 3（将来の目標）
1. **AI支援**: 基本的なAI機能が実装される
2. **管理機能**: 企業向け管理ダッシュボードが実装される
3. **モバイル**: モバイル対応が完了する
4. **ユーザー満足度**: NPS 60以上
5. **採用率**: 月間10%成長率

## 7. 制約事項

### 技術的制約
- WebRTC標準準拠（getDisplayMedia API使用）
- ブラウザセキュリティポリシーの制限（CORS、Same-Origin Policy）
- Chrome拡張機能またはElectronアプリが必要（リモート操作実行のため）
- HTTPSが必須（WebRTC要件）
- 既存の2Dウィンドウマネージャーとの後方互換性維持

### パフォーマンス制約
- Phase 1: 3-5個のストリームで安定動作
- Phase 2: 10個以上のストリームで30fps目標
- ネットワーク帯域: 最低5Mbps推奨

### セキュリティ制約
- Phase 1: 基本的なトークン認証
- Phase 2: エンドツーエンド暗号化
- Phase 3: エンタープライズグレードのセキュリティ

### リソース制約
- 段階的な実装アプローチ
- 既存コードベースの活用
- オープンソースライブラリの活用